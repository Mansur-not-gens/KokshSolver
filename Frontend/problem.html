<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Лента проблем — KokshSolver</title>
<link rel="stylesheet" href="problem.css">
</head>
<body>

<header class="header">
  <div class="container flex-sb">
    <div class="logo">KokshSolver</div>
    <nav class="nav">
      <a href="index.html">Главная</a>
      <a href="problem.html" class="active">Проблемы</a>
    </nav>
    <button class="btn-green" id="openModal">Сообщить проблему</button>
  </div>
</header>

<main class="container">
  <h1 class="page-title">Лента городских проблем</h1>
  <div class="problems-feed"></div>
</main>

<footer class="footer">
  <p>© 2026 KokshSolver</p>
</footer>

<!-- Модалка -->
<div id="postModal" style="display:none;">
  <div class="modal-content">
    <span class="close">&times;</span>
    <form id="newPostForm">
      <input name="title" placeholder="Заголовок" required>
      <textarea name="content" placeholder="Описание проблемы" required></textarea>
      <input name="image_url" placeholder="URL картинки">
      <button type="submit">Создать</button>
    </form>
    <div id="message"></div>
  </div>
</div>

<script>
const API_URL = "https://kokshsolver.onrender.com";
const feed = document.querySelector(".problems-feed");

// ----------------------
// Загрузка всех постов
// ----------------------
function loadPosts() {
  fetch(`${API_URL}/api/posts`)
    .then(res => res.json())
    .then(posts => {
      feed.innerHTML = "";
      posts.forEach(renderPost);
    })
    .catch(err => console.error("Ошибка загрузки:", err));
}

// ----------------------
// Рендер поста
// ----------------------
function renderPost(post) {

  const badgeColor =
    post.status === "important" ? "red" :
    post.status === "in_progress" ? "yellow" : "green";

  const statusText =
    post.status === "important" ? "Важное" :
    post.status === "in_progress" ? "В работе" : "Решено";

  const div = document.createElement("div");
  div.className = "problem-item";

  div.innerHTML = `
    ${post.image_url ? `<img src="${post.image_url}" class="feed-img">` : ""}
    <div class="feed-content">
      <div class="feed-header">
        <span class="badge ${badgeColor}">${statusText}</span>
      </div>

      <h3>${post.title}</h3>
      <p>${post.content}</p>

      <div class="comments"></div>

      <div class="feed-footer">
        <span><b>${post.votes}</b> голосов</span>
        <button class="btn-vote">Голосовать</button>
      </div>
    </div>
  `;

  feed.prepend(div);

  // --- Загрузка комментариев ---
  fetch(`${API_URL}/api/posts/${post.id}/comments`)
    .then(res => res.json())
    .then(comments => {
      const commentsDiv = div.querySelector(".comments");
      comments.forEach(c => {
        commentsDiv.innerHTML += 
          `<div class="comment"><strong>${c.author || "Пользователь"}:</strong> ${c.text}</div>`;
      });
    });

  // --- Голосование ---
  div.querySelector(".btn-vote").onclick = () => {
    fetch(`${API_URL}/api/posts/${post.id}/vote`, { method: "POST" })
      .then(res => res.json())
      .then(updated => {
        div.querySelector("b").textContent = updated.votes;
      });
  };
}

// ----------------------
// Создание нового поста
// ----------------------
const modal = document.getElementById("postModal");
const form = document.getElementById("newPostForm");
const message = document.getElementById("message");

document.getElementById("openModal").onclick = () => modal.style.display = "block";
document.querySelector(".close").onclick = () => modal.style.display = "none";

form.onsubmit = e => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(form).entries());

  fetch(`${API_URL}/api/posts`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(post => {
    message.textContent = "Проблема создана!";
    form.reset();
    modal.style.display = "none";
    loadPosts();
  })
  .catch(err => {
    message.textContent = "Ошибка создания.";
    console.error(err);
  });
};

// Запуск
loadPosts();
</script>

</body>
</html>




